name: HMDA PR CVE Scan

on:
  pull_request:
    types: [opened, synchronize, reopened] # to run the scan on each push and reopens

jobs:
  hmda-platform-cve-scan:
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: pr-cve-scan
      IMAGE_TAG: latest

    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Build image of HMDA platform
        run: |
          sbt -batch clean hmda-platform/docker:dockerPublishLocalSkipTests
        continue-on-error: true

      - name: Tag Docker image
        run: docker tag $(docker images --filter=reference="hmda/hmda-platform:$IMAGE_TAG" --format "{{.ID}}") hmda-cve/hmda-platform:$IMAGE_NAME

      - name: Run Snyk CVE scan
        uses: snyk/actions/docker@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: hmda-cve/hmda-platform:$IMAGE_NAME
          args: --severity-threshold=high

      - name: Remove Docker image
        run: |
          docker rmi hmda-cve/hmda-platform:$IMAGE_NAME